<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Troubleshooting TLS handshake issue | Learnings in IT</title>
<meta name="keywords" content="Wireshark, TCP, TLS, .NET, Schannel, SSPI, Bouncy Castle">
<meta name="description" content="Background
Ever encountered a scenario where REST API consumption works from tools like curl, Web Browser but not from Application. Lets dive in.
The requirement is as simple as consuming REST API from a Application over TLS.
Problem Statement
The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.
During Development, Windows 10 is used to develop and test the code. Later, the same is tested on a Windows 2016 Server. It is at this stage, it fails with cryptic Error &ldquo;The request was aborted: Could not create SSL/TLS secure channel&rdquo;. But it works fine with other tools like curl, PostMan or even from a Web Browser.">
<meta name="author" content="map[name:Sachin Sunkle]">
<link rel="canonical" href="http://localhost:1313/posts/tlshandsharefailure/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/tlshandsharefailure/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Learnings in IT (Alt + H)">Learnings in IT</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://gist.github.com/sachinsu" title="Gists">
                    <span>Gists</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/links/home" title="Useful Links">
                    <span>Useful Links</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Troubleshooting TLS handshake issue
    </h1>
    <div class="post-meta"><span title='2023-02-25 10:25:04 +0530 IST'>Feb 25 2023</span>&nbsp;Â·&nbsp;map[name:Sachin Sunkle]

</div>
  </header> 
  <div class="post-content"><h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>Ever encountered a scenario where REST API consumption works from tools like <a href=https://github.com/jeroen/curl
    
    target=_blank rel="noopener noreferrer"
>curl</a>, Web Browser but not from Application. Lets dive in.</p>
<p>The requirement is as simple as consuming REST API from a Application over TLS.</p>
<h2 id="problem-statement">Problem Statement<a hidden class="anchor" aria-hidden="true" href="#problem-statement">#</a></h2>
<p>The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.</p>
<p>During Development, Windows 10 is used to develop and test the code. Later, the same is tested on a Windows 2016 Server. It is at this stage, it fails with cryptic Error &ldquo;The request was aborted: Could not create SSL/TLS secure channel&rdquo;. But it works fine with other tools like curl, PostMan or even from a Web Browser.</p>
<figure>
    <img loading="lazy" src="/images/wireshark-dotnet-error.png"/> <figcaption>
            Network trace log from Application
        </figcaption>
</figure>

<h2 id="causal-analysis">Causal Analysis<a hidden class="anchor" aria-hidden="true" href="#causal-analysis">#</a></h2>
<p>Given that this error was related TLS/SSL and it is standard across platforms. What could be the reason for this behavior? With not much luck with Application level trace, its time to take help of <a href=https://www.wireshark.org/
    
    target=_blank rel="noopener noreferrer"
>Wireshark</a>. If you are new to Wireshark then refer to <a href=https://jvns.ca/blog/2018/06/19/what-i-use-wireshark-for/
    
    target=_blank rel="noopener noreferrer"
>this</a> excellent write-up by Julia Evans.</p>
<p>So, i used wireshark during test from CURL as well as from the Application and below is what is shows,</p>
<h3 id="using-curl">Using CURL<a hidden class="anchor" aria-hidden="true" href="#using-curl">#</a></h3>
<figure>
    <img loading="lazy" src="/images/wireshark-curl-1.png"/> <figcaption>
            List of Ciphers Exchanged during &#39;Client Hello&#39;
        </figcaption>
</figure>

<figure>
    <img loading="lazy" src="/images/wireshark-curl-2.png"/> <figcaption>
            Cipher returned by Server during &#39;Server Hello&#39;
        </figcaption>
</figure>

<p>With CURl, TLS handshare happens as intended and API works as expected.</p>
<h3 id="via-application">Via Application<a hidden class="anchor" aria-hidden="true" href="#via-application">#</a></h3>
<ul>
<li>
<p>Below is list of ciphers exchanged and list is considerably short compared to earlier.</p>
<figure>
        <img loading="lazy" src="/images/wireshark-app-1.png"/> <figcaption>
                List of Ciphers Exchanged during &#39;Client Hello&#39;
            </figcaption>
    </figure>

</li>
<li>
<p>Below is error logged</p>
<figure>
        <img loading="lazy" src="/images/wireshark-app-2.png"/> <figcaption>
                TLS handshake Error
            </figcaption>
    </figure>

</li>
</ul>
<p>To understand this behavior, Let&rsquo;s do a quick primer.</p>
<p>There are many implementations of TLS/SSL (a.k.a. Security service providers) available across platforms. Notably,</p>
<ul>
<li>
<p><a href=https://en.wikipedia.org/wiki/Network_Security_Services
    
    target=_blank rel="noopener noreferrer"
>Network Security Services</a> This is used by browsers like Firefox</p>
</li>
<li>
<p><a href=https://en.wikipedia.org/wiki/LibreSSL
    
    target=_blank rel="noopener noreferrer"
>LibreSSL</a> - Used by Chrome, curl (in ready-to-use build, refer <a href=https://everything.curl.dev/build/tls
    
    target=_blank rel="noopener noreferrer"
>here</a>)</p>
</li>
</ul>
<p>Refer <a href=https://en.wikipedia.org/wiki/Comparison_of_TLS_implementations
    
    target=_blank rel="noopener noreferrer"
>here</a> for nice comparison of various implementations in summary format.</p>
<p>`Microsoft Windows has its own Implementation called Windows SSPI (a.k.a. schannel SSPI). As per <a href=https://learn.microsoft.com/en-us/windows-server/security/tls/tls-ssl-schannel-ssp-overview
    
    target=_blank rel="noopener noreferrer"
>TLS/SSL Overview</a>,</p>
<pre tabindex="0"><code>
Schannel is a Security Support Provider (SSP) that implements the Secure Sockets Layer (SSL) and Transport Layer Security (TLS) Internet standard authentication protocols.
</code></pre><p>Microsoft Windows and development platforms like .NET use this implementation by default. Via this provider it is possible for Administrators to enforce policies like restrict version of TLS, usage of ciphers and so on. Note that, as part of Security/Compliance requirements, It is often necessary to have these policies enforced and this is exactly what was done.</p>
<p>Below is Sample C# code using <a href=https://github.com/bcgit/bc-csharp
    
    target=_blank rel="noopener noreferrer"
>BouncyCastle</a> (alternate library for cryptography)</p>

<iframe src="//carbon.now.sh/embed/22bb5e70334101dba1880de3a6c0e504"
    style="transform:scale(0.9); width:1024px; height:473px; border:0; overflow:hidden;"
    sandbox="allow-scripts allow-same-origin">
</iframe>

<h2 id="wrap-up">Wrap up<a hidden class="anchor" aria-hidden="true" href="#wrap-up">#</a></h2>
<p>Hence, the resolution for this could be,</p>
<ul>
<li>Make sure that Server hosting the API complies with any of the ciphers allowed on the client.</li>
<li>In case if this is not possible then , Cipher restrictions on the client will have to be modified (assuming its within the requirement for Compliance).</li>
</ul>
<h3 id="useful-references">Useful References,<a hidden class="anchor" aria-hidden="true" href="#useful-references">#</a></h3>
<p>1 - <a href=https://github.com/jeroen/curl/issues/100
    
    target=_blank rel="noopener noreferrer"
>CURL using OpenSSL in default build</a></p>
<p>Happy Troubleshooting !!</p>
<hr>
<script src="https://utteranc.es/client.js" repo="sachinsu/sachinsu.github.io" issue-term="title" label="blogcomment"
    theme="github-light" crossorigin="anonymous" async></script>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/wireshark/">Wireshark</a></li>
      <li><a href="http://localhost:1313/tags/tcp/">TCP</a></li>
      <li><a href="http://localhost:1313/tags/tls/">TLS</a></li>
      <li><a href="http://localhost:1313/tags/.net/">.NET</a></li>
      <li><a href="http://localhost:1313/tags/schannel/">Schannel</a></li>
      <li><a href="http://localhost:1313/tags/sspi/">SSPI</a></li>
      <li><a href="http://localhost:1313/tags/bouncy-castle/">Bouncy Castle</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Learnings in IT</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
