<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Trobleshooting TCP Connection request time outs | Learnings in IT</title>
<meta name="keywords" content="Oracle, TCP, Firewall, .NET, Polly">
<meta name="description" content="Background
I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,

     
            High Level Architecture
        


Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic. These applications connect to Oracle Database.">
<meta name="author" content="map[name:Sachin Sunkle]">
<link rel="canonical" href="http://localhost:1313/posts/connectiontimeouts/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/connectiontimeouts/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Learnings in IT (Alt + H)">Learnings in IT</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://gist.github.com/sachinsu" title="Gists">
                    <span>Gists</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/links/home" title="Useful Links">
                    <span>Useful Links</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Trobleshooting TCP Connection request time outs
    </h1>
    <div class="post-meta"><span title='2020-08-25 10:25:04 +0530 IST'>Aug 25 2020</span>&nbsp;·&nbsp;map[name:Sachin Sunkle]

</div>
  </header> 
  <div class="post-content"><h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.</p>
<p>Simplified deployment Architecture is as below,</p>
<figure>
    <img loading="lazy" src="/images/conntimeoutarch.png"/> <figcaption>
            High Level Architecture
        </figcaption>
</figure>

<p>Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic. These applications connect to Oracle Database.</p>
<p>Team is experienced in developing and running .NET Apps, but they needed help to diagnose and fix &ldquo;Connection request timed out&rdquo; exceptions being thrown while connecting to backend database.</p>
<h2 id="problem-statement">Problem Statement<a hidden class="anchor" aria-hidden="true" href="#problem-statement">#</a></h2>
<p>Host of .NET Applications (Web Applications, Web APIs) connect to Oracle Database. Each of them use <a href=https://www.oracle.com/database/technologies/appdev/dotnet/odp.html
    
    target=_blank rel="noopener noreferrer"
>ODP.NET</a>. ODP.NET maintains connection pool per Application domain (Database resident Connection pool is not used). Some of these applications receive high number of requests per second compared to others.</p>
<p><code>Oracle.ManagedDataAccess.Client.OracleException (0x80004005): Connection request timed out....</code> has been reported randomly which results in failure of business transactions. ODP.NET provides extensive trace and along with above trace also contains <code>OracleInternal.Network.NetworkException (0x80004005): Network Transport: TCP transport address connect failure ---&gt; System.Net.Sockets.SocketException (0x80004005): A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond</code></p>
<p>Specifically, Applications, receiving less traffic, were reporting it often compared to those with high traffic.</p>
<h2 id="approach">Approach<a hidden class="anchor" aria-hidden="true" href="#approach">#</a></h2>
<ul>
<li>Simulate the Exception in Test Environment - We decided to try and simulate this exception in a Test Environment. Test environment is scaled down (50%) compared to production. Random Exceptions in production could not be simulated due to lack of Test Automation. for example, In Production, each server receives traffic for multiple HTTP End points whereas in Test environment, load testing was being done only against Single Application.</li>
</ul>
<p>This was like a end of the road since simulation would have greatly helped in diagnosing the issue. However, the show must go on so we decided to,</p>
<ul>
<li>
<p>Check online documentation regarding this exception,</p>
<ul>
<li>
<p>&ldquo;Pooled&rdquo; or &ldquo;Non-pooled&rdquo; Connection - Whenever, ODP.NET raises &ldquo;..timed out&rdquo; error, it diffrentiates the same to indicate whether error is due to delay in retrieving connection from pool or if it is due to delay from the database server (Ref: <a href=https://docs.oracle.com/en/database/oracle/oracle-data-access-components/19.3/odpnt/featConnecting.html#GUID-1152D13D-464C-4FE7-9949-32FCA9572B59
    
    target=_blank rel="noopener noreferrer"
>Here</a>). From this, it was clear that issue is clearly due to delay in obtaining response from database server.While this was happening , Database server (8 CPU Core box) was reporting less than 50% CPU Usage but it still had large number of inactive sessions originated from IIS Servers.</p>
</li>
<li>
<p>Since the exception was reported frequently in low traffic applications, it was decided to track and verify the same on firewall and database server,</p>
<ul>
<li>
<p>Firewall - Firewall had TCP Timeout of 30 minutes and  maintains detailed log of sessions. Quick analysis of it revealed that,</p>
<ul>
<li>Production Environment - Unusually high number of sessions were being destroyed due to &ldquo;Age out&rdquo; (i.e. time out)</li>
<li>Test Environment - No abnormal activity was reported. Most probably because of differences in traffic.</li>
</ul>
</li>
<li>
<p>Database Server - Listener Log on Oracle Database server did not had any log entry for request at the precise time when Application(s) had reported Exception.</p>
</li>
</ul>
</li>
<li>
<p>Next is to check settings in Application for connectivity with Oracle. Though ODP.NET does not have any direct  &ldquo;Time out&rdquo; or &ldquo;Time to live&rdquo; settings, it does provide few parameters that can influence it,</p>
<ul>
<li>&ldquo;Connection Lifetime&rdquo; - ODP.NET uses this whenever Connection is closed and disposed by the Application. It will be destroyed (after maintaining number of connections as per &ldquo;Min Pool Size&rdquo;)  if it has exceeded life time. For whatever reasons, this was set to unusually high duration (i.e. 90000 seconds).</li>
<li>&ldquo;Connection Timeout&rdquo; - Period for which ODP.NET waits for the connection to be made available. This was set to 60 Seconds.</li>
</ul>
</li>
<li>
<p>Oracle has articles titled &ldquo;ODP-1000 &ldquo;Connection Request Timed Out&rdquo; Explained&rdquo; and &ldquo;Resolving Problems with Connection Idle Timeout With Firewall (Doc ID 257650.1)&rdquo; where it primarily recommends measures for tuning Application as well as database.</p>
</li>
</ul>
<p>On the basis of above, it was decided to modify the code for below,</p>
<ul>
<li>Thorough code review to verify that every ODP.NET Project is closed/disposed.</li>
<li>Upgrade ODP.NET to latest version (v19.8.0 as of this writing)</li>
<li>Turn &ldquo;KeepAlive&rdquo; while connecting to database</li>
<li>Leverage ODP.NET tracing in case of exception</li>
<li>Modify the connection lifetime to be less than time out at firewall and increase the &ldquo;Time out&rdquo; period.</li>
<li>Introduce Retry functionality using Excellent <a href=https://github.com/App-vNext/Polly
    
    target=_blank rel="noopener noreferrer"
>Polly</a> library with exponential back-off.</li>
</ul>
<p><code>
<iframe src="//carbon.now.sh/embed/d3888ab4418b937a650e880ec4682653?filename=extensions.cs"
    style="transform:scale(0.9); width:1024px; height:473px; border:0; overflow:hidden;"
    sandbox="allow-scripts allow-same-origin">
</iframe>
</code></p>
<p>These changes have been deployed to production and so far % of &ldquo;Connection Request Timed out&rdquo; errors have gone down significantly.</p>
</li>
</ul>
<h2 id="wrap-up">Wrap up<a hidden class="anchor" aria-hidden="true" href="#wrap-up">#</a></h2>
<p>Some key areas of focus are,</p>
<ul>
<li>For a distributed system, Always validate assumptions by dignosing end to end.</li>
<li>Plan to have test automation readyness to simulate production like load.</li>
<li>Monitoring the behavior end to end using logs.</li>
<li>Currently, Pool settings across applications is not optimal going by Oracle Real world Guidelines, also be mindful of <a href=https://docs.oracle.com/en/database/oracle/oracle-database/18/adfns/connection_strategies.html
    
    target=_blank rel="noopener noreferrer"
>Connection Storms</a></li>
</ul>
<p>Happy Troubleshooting !!</p>
<hr>
<script src="https://utteranc.es/client.js" repo="sachinsu/sachinsu.github.io" issue-term="title" label="blogcomment"
    theme="github-light" crossorigin="anonymous" async></script>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/oracle/">Oracle</a></li>
      <li><a href="http://localhost:1313/tags/tcp/">TCP</a></li>
      <li><a href="http://localhost:1313/tags/firewall/">Firewall</a></li>
      <li><a href="http://localhost:1313/tags/.net/">.NET</a></li>
      <li><a href="http://localhost:1313/tags/polly/">Polly</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Learnings in IT</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
