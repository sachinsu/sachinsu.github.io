<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>ELT approach for Data Pipelines | Learnings in IT</title>
<meta name="keywords" content="DBT, ELT, ETL, Python, Go, PostgreSQL, CSV, data pipeline, nsetools">
<meta name="description" content="Introduction
While gathering data for Analytics, one often has to source data from multiple sources. Traditionally, the approach has been to do ETL (Extract-Transform-load) where,

Extract - typically involves retrieving data from source. This could also be via streaming
Transform - Apply transformation to the extracted data.
Load -  Loading the data in Operation Data store (ODS) or data warehouse
Refer here for more details on ETL. ETL has been made easy by tools like Talend, SSIS and so on.

However, there has been shift from above approach due to,">
<meta name="author" content="map[name:Sachin Sunkle]">
<link rel="canonical" href="http://localhost:1313/posts/elt/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/elt/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Learnings in IT (Alt + H)">Learnings in IT</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://gist.github.com/sachinsu" title="Gists">
                    <span>Gists</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/links/home" title="Useful Links">
                    <span>Useful Links</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      ELT approach for Data Pipelines
    </h1>
    <div class="post-meta"><span title='2021-03-14 00:00:00 +0530 IST'>Mar 14 2021</span>&nbsp;·&nbsp;map[name:Sachin Sunkle]

</div>
  </header> 
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>While gathering data for Analytics, one often has to source data from multiple sources. Traditionally, the approach has been to do ETL (Extract-Transform-load) where,</p>
<ul>
<li><strong>Extract</strong> - typically involves retrieving data from source. This could also be via streaming</li>
<li><strong>Transform</strong> - Apply transformation to the extracted data.</li>
<li><strong>Load</strong> -  Loading the data in Operation Data store (ODS) or data warehouse
Refer <a href=https://www.sas.com/en_us/insights/data-management/what-is-etl.html#close
    
    target=_blank rel="noopener noreferrer"
>here</a> for more details on ETL. ETL has been made easy by tools like <a href=https://www.talend.com/products/talend-open-studio/
    
    target=_blank rel="noopener noreferrer"
>Talend</a>, <a href=https://docs.microsoft.com/en-us/sql/integration-services/sql-server-integration-services
    
    target=_blank rel="noopener noreferrer"
>SSIS</a> and so on.</li>
</ul>
<p>However, there has been shift from above approach due to,</p>
<ul>
<li>Need to handle different kinds of data (Structured and Unstructured)</li>
<li>hugh volumes of data (IOT, Customer data management)</li>
<li>Availability of cheaper storage and compute along with availability of internet scale cloud based data warehouses</li>
</ul>
<p>has recently caused wide adoption of ELT (Extract-transform-load) over ETL.</p>
<p>ELT offers an alternative to ETL in which data is loaded into the warehouse (sometimes in storage area called as data lake) before transforming it. It allows focussing on extraction and loading with heavy transformation offloaded to later stage. Since the transformation happens in the warehouse, it can potentially be defined using SQL (thus using same language across the pipeline). This allows more roles (say Data Analysts) to contribute to (or entirely own) the transformation logic. Data warehouse becomes single source of truth for data. Ref: <a href=https://dataschool.com/data-governance/etl-vs-elt/
    
    target=_blank rel="noopener noreferrer"
>ETL vs ELT</a></p>
<p>Typically, Data flow pipeline consists of below phases (it also lists available tools for each phase),</p>
<ul>
<li>Ingestion - <a href=https://airbyte.io
    
    target=_blank rel="noopener noreferrer"
>Airbyte</a>, <a href=https://fivetran.com
    
    target=_blank rel="noopener noreferrer"
>Fivetran</a>, <a href=https://stitchdata.com
    
    target=_blank rel="noopener noreferrer"
>Stitch</a></li>
<li>Warehousing - <a href=https://snowflake.com
    
    target=_blank rel="noopener noreferrer"
>Snowflake</a>, <a href=https://cloud.google.com/bigquery
    
    target=_blank rel="noopener noreferrer"
>BigQuery</a>, <a href=https://aws.amazon.com/redshift
    
    target=_blank rel="noopener noreferrer"
>Redshift</a>, <a href=https://postgresql.org
    
    target=_blank rel="noopener noreferrer"
>PostgreSQL</a></li>
<li>Transformation - <a href=https://getdbt.com
    
    target=_blank rel="noopener noreferrer"
>dbt</a></li>
<li>Orchestration - <a href=airflow.apache.org
    
    
>Airflow</a>, <a href=https://prefect.io
    
    target=_blank rel="noopener noreferrer"
>Prefect</a>, <a href=https://dagster.io
    
    target=_blank rel="noopener noreferrer"
>Dagster</a></li>
<li>BI - <a href=superset.apache.org
    
    
>Superset</a>, <a href=https://metabase.com
    
    target=_blank rel="noopener noreferrer"
>Metabase</a>, <a href=redash.io
    
    
>Redash</a>, <a href=looker.com
    
    
>Looker</a> etc.</li>
</ul>
<p>I think the best way to understand the landscape is to use above tools. So i decided to implement below problem statement. The requirement is to run a weekly process that,</p>
<ol>
<li>Downloads list of CNX 500 companies from Exchange&rsquo;s web site</li>
<li>For each of the company , get Last traded price(<code>ltp</code>) and 52 week high price (<code>yearlyhigh</code>)</li>
<li>Exclude companies having ltp &lt; 20 or ltp &gt; 50000</li>
<li>Rank companies by closeness of <code>ltp</code> to <code>yearlyhigh</code></li>
<li>Prepare <code>buy</code> list of up to 20 such companies. Earlier short listed stocks, which are not in top 20 this week or further than 5% from their <code>yearlyhigh</code>, should be marked for <code>sell</code>.</li>
</ol>
<p>Above is hypothetical example and using full fledged data stack may be overkill but should suffice the purpose of this article.</p>
<h3 id="e--l-in-elt----get-the-list-of-cnx-500-companies-and-also-get-stock-price-for-each-of-them"><code>E</code> &amp; <code>L</code> in ELT -  Get the list of CNX 500 Companies and also get stock price for each of them<a hidden class="anchor" aria-hidden="true" href="#e--l-in-elt----get-the-list-of-cnx-500-companies-and-also-get-stock-price-for-each-of-them">#</a></h3>
<p>Below are some of the options available for this task under <code>extract</code> and <code>load</code> category,</p>
<ul>
<li>Use Python to download list of stocks and then use <a href=https://pypi.org/project/yfinance/
    
    target=_blank rel="noopener noreferrer"
>yfinance</a> to get the price and yearly high.</li>
<li>Use tool like <a href=https://airbyte.io
    
    target=_blank rel="noopener noreferrer"
>Airbyte</a> which provides declarative way of importing the data via HTTP. I am planning to explore this option later.</li>
<li>Use Go to perform the task. I decided to go with this one and code is available at <a href=https://github.com/sachinsu/momentumflow/tree/main/gover
    
    target=_blank rel="noopener noreferrer"
>here</a>. It downloads CSV file from Exchange&rsquo;s website (containing list of stocks in Index) and loads them to database. Since Yahoo finance no longer provides Free tier for API, It uses <a href=github.com/antchfx/htmlquery
    
    
>htmlquery</a> library to parse HTML and retrieve stock price and yearly high value.</li>
</ul>
<h3 id="t-in-elt---transform-the-company-wise-data-to-arrive-at-weekly-list-of-momentum-stocks"><code>T</code> in ELT - Transform the company-wise data to arrive at weekly list of momentum stocks<a hidden class="anchor" aria-hidden="true" href="#t-in-elt---transform-the-company-wise-data-to-arrive-at-weekly-list-of-momentum-stocks">#</a></h3>
<p>This is implemented using <a href=https://getdbt.com
    
    target=_blank rel="noopener noreferrer"
>dbt</a>. dbt (Data Build Tool) is a framework to facilitate transformations using SQL along with version control, automates tests, support for incremental load, snapshots and so on. It has <code>notion</code> of <strong>project</strong> or <strong>workspace</strong> that many developers are familiar with.
It is offered as Command line interface (CLI)  as well as on cloud which also provides web based UI. I have used CLI for this exercise. For a quick recap of dbt folder structure, refer [here]https://towardsdatascience.com/data-stacks-for-fun-nonprofit-part-ii-d375d824abf3).</p>
<p>Source code of dbt project <a href=https://github.com/sachinsu/momentumflow/tree/main/dbt
    
    target=_blank rel="noopener noreferrer"
>here</a>.  We will go through key part of this project which are Models that carry out the transformation. After the initial setup of dbt like configuring target (i.e. data source which in this case is a PostgreSQL database), below are Models used,</p>
<ul>
<li>
<p>Since Loading  of company-wise data is already done in earlier step, next step is to rank the companies w.r.t. <code>closeness</code> to their yearly high. Below is <code>dbt</code> SQL which does it (At run time, dbt converts below SQL to the one understood by the Target database),</p>
<pre><code> ```

 {{
     config(
         materialized='incremental',
     )
 }}

 with
     cnxcompanies
     as
     (

         select
             symbol,
             company,
             ltp,
             yearlyhigh,
             updatedat,
             rank() over (order by yearlyhigh-ltp) as diff_rank
         from {{ source('datastore', 'cnx500companies') }}
     where yearlyhigh::money::numeric::float8 - ltp::money::numeric::float8 &gt; 0 and ltp::money::numeric::float8 &gt; 20 and ltp::money::numeric::float8 &lt; 50000

 ),
 cnxtopstocks as
 (

     select
     symbol,
     company,
     ltp,
     yearlyhigh,
     updatedat,
     diff_rank
     from  cnxcompanies
     order by updatedat desc,diff_rank 
 )

 select * from cnxtopstocks

 ```
</code></pre>
<p>Above model creates corresponding table in database (as such dbt abstracts changes to database from developer and manages it on its own). Note that model is marked <code>incremental</code> so that it doesn&rsquo;t overwrite the table on every run but rather incrementally applies changes.</p>
</li>
<li>
<p>Next step is to arrive at Weekly list of stocks to <code>buy</code> and even <code>sell</code> those which are lacking momentum.</p>
<pre><code>  ```

  {{
  config(
  materialized='incremental',
  unique_key='concat(symbol,updatedat)'
      )
  }}

  with currentlist as (
      select distinct symbol,
              company,
              ltp,
              yearlyhigh,
              updatedat,diff_rank,'buy' as buyorsell
      from  {{ref('rankstocks')}} 
      where (yearlyhigh-ltp)/ltp*100 &lt;= 5
      order by updatedat desc, diff_rank
      limit 20
  ),
  finallist as (
      {% if is_incremental() %}
          select symbol,
              company,
              ltp,
              yearlyhigh,
              updatedat,diff_rank,'sell' as buyorsell from {{this}} as oldlist
              where not exists (select symbol from currentlist where symbol=oldlist.symbol and (yearlyhigh-ltp)/ltp*100 &lt;= 5 )
          union 
          select  symbol,
              company,
              ltp,
              yearlyhigh,
              updatedat,diff_rank,'buy' as buyorsell  from  currentlist 
              where not exists (select symbol from {{this}} where symbol=currentlist.symbol and buyorsell='buy')   
      {% else %}
          select * from currentlist
      {% endif %}
  )


  select * from finallist

  ```
</code></pre>
<p>This model refers to earlier one using <code>{{..}}</code> jinja directive. It also refers to itself using <code>{{this}}</code> directive.</p>
<p>Among others, below are key feature of DBT that were observed,</p>
<ul>
<li>Concept of Project/Workspace which programmers are typically familiar with</li>
<li>Using SQL for Data Transformation</li>
<li>Support for Version control</li>
<li>Support for testing</li>
<li>Support for incremental load</li>
<li>Support for snapshots</li>
<li>Automatic schema updates</li>
<li>Out of the box Documentation browser covering traceability across sources and models.</li>
</ul>
</li>
</ul>
<h3 id="orchestration">Orchestration<a hidden class="anchor" aria-hidden="true" href="#orchestration">#</a></h3>
<p>After completing <code>ELT</code> aspects, now it&rsquo;s time to  orchestrate this pipeline wherein the whole process will run every week. Typically, one can use task scheduler like Airflow or Prefect to do this. But for the purpose of this article, lets use <a href=https://docs.microsoft.com/en-us/troubleshoot/windows-client/system-management-components/use-at-command-to-schedule-tasks
    
    target=_blank rel="noopener noreferrer"
>at</a> on windows (or <a href=https://en.wikipedia.org/wiki/Cron
    
    target=_blank rel="noopener noreferrer"
>cron</a> if you are using Linux).</p>
<p>so a simplest possible batch file (as below),</p>
<pre tabindex="0"><code>set http_proxy=
set https_proxy=

.\gover\go run .

.\.venv\scripts\activate &amp; .\dbt\dbt run
</code></pre><p>will run the whole process and generate weekly list in <code>weeklylist</code> table in database. This batch file can be scheduled to run on weekly basis using command <code>at 23:00 /every:F runscript.bat</code>.</p>
<p>This is very basic approach to scheduling (with no error handling/retries or monitoring). Hopefully, i will be able to work on these part (something like <a href=https://docs.airbyte.io/tutorials/connecting-el-with-t-using-dbt
    
    target=_blank rel="noopener noreferrer"
>this</a>). Till then&hellip;</p>
<h3 id="useful-references">Useful References<a hidden class="anchor" aria-hidden="true" href="#useful-references">#</a></h3>
<ul>
<li><a href=https://medium.com/memory-leak/reverse-etl-a-primer-4e6694dcc7fb
    
    target=_blank rel="noopener noreferrer"
>Reverse ETL</a></li>
<li><a href=https://towardsdatascience.com/data-stacks-for-fun-nonprofit-part-ii-d375d824abf3
    
    target=_blank rel="noopener noreferrer"
>Data stacks for Fun and Profit</a></li>
<li><a href=https://dataschool.com/data-governance/what-warehouse-to-use/
    
    target=_blank rel="noopener noreferrer"
>What warehouse to use</a></li>
<li><a href=https://tech.fretlink.com/build-your-own-data-lake-for-reporting-purposes/
    
    target=_blank rel="noopener noreferrer"
>Build Data Lake in PostgreSQL using FDW, Singer, Metabase</a></li>
</ul>
<p>Happy Coding !!</p>
<hr>
<script src="https://utteranc.es/client.js" repo="sachinsu/sachinsu.github.io" issue-term="title" label="blogcomment"
    theme="github-light" crossorigin="anonymous" async></script>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/dbt/">DBT</a></li>
      <li><a href="http://localhost:1313/tags/elt/">ELT</a></li>
      <li><a href="http://localhost:1313/tags/etl/">ETL</a></li>
      <li><a href="http://localhost:1313/tags/python/">Python</a></li>
      <li><a href="http://localhost:1313/tags/go/">Go</a></li>
      <li><a href="http://localhost:1313/tags/postgresql/">Postgresql</a></li>
      <li><a href="http://localhost:1313/tags/csv/">CSV</a></li>
      <li><a href="http://localhost:1313/tags/data-pipeline/">Data Pipeline</a></li>
      <li><a href="http://localhost:1313/tags/nsetools/">Nsetools</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Learnings in IT</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
