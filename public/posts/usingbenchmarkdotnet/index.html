<!doctype html><html class=no-js lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Optimizing .NET Code using Benchmarks - Learnings in IT</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:url" content="http://localhost:1313/posts/usingbenchmarkdotnet/"><meta property="og:site_name" content="Learnings in IT"><meta property="og:title" content="Optimizing  .NET Code using Benchmarks"><meta property="og:description" content="Background Oftentimes, we come across situation where code does not perform as per expectation. What is typically approch to address it,
Performance Testing - Visual Studio Load Tests or Third party tools like Locust, Vegeta, Gatling etc. Visual Studio Diagnostics Tools Or Use tools like Perfview/dotTrace/dotMemory to diagnose bottlenecks What if it is possible to Benchmark code for,"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-05T10:25:04+05:30"><meta property="article:modified_time" content="2020-05-05T10:25:04+05:30"><meta itemprop=name content="Optimizing  .NET Code using Benchmarks"><meta itemprop=description content="Background Oftentimes, we come across situation where code does not perform as per expectation. What is typically approch to address it,
Performance Testing - Visual Studio Load Tests or Third party tools like Locust, Vegeta, Gatling etc. Visual Studio Diagnostics Tools Or Use tools like Perfview/dotTrace/dotMemory to diagnose bottlenecks What if it is possible to Benchmark code for,"><meta itemprop=datePublished content="2020-05-05T10:25:04+05:30"><meta itemprop=dateModified content="2020-05-05T10:25:04+05:30"><meta itemprop=wordCount content="341"><meta name=twitter:card content="summary"><meta name=twitter:title content="Optimizing  .NET Code using Benchmarks"><meta name=twitter:description content="Background Oftentimes, we come across situation where code does not perform as per expectation. What is typically approch to address it,
Performance Testing - Visual Studio Load Tests or Third party tools like Locust, Vegeta, Gatling etc. Visual Studio Diagnostics Tools Or Use tools like Perfview/dotTrace/dotMemory to diagnose bottlenecks What if it is possible to Benchmark code for,"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Learnings in IT" rel=home><div class="logo__item logo__text"><div class=logo__title>Learnings in IT</div><div class=logo__tagline>A Simple Technical Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li><li class=menu__item><a class=menu__link href=/posts/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/projects/><span class=menu__text>Projects</span></a></li><li class=menu__item><a class=menu__link href=https://gist.github.com/sachinsu><span class=menu__text>Gists</span></a></li><li class=menu__item><a class=menu__link href=/links/home><span class=menu__text>Useful Links</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Optimizing .NET Code using Benchmarks</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2020-05-05T10:25:04+05:30>May 5 2020</time></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#approach>Approach</a></li></ul></nav></div></div><div class="content post__content clearfix"><h2 id=background>Background</h2><p>Oftentimes, we come across situation where code does not perform as per expectation. What is typically approch to address it,</p><ul><li>Performance Testing - Visual Studio Load Tests or Third party tools like <a href=https://locust.io/ target=_blank rel="noopener noreferrer">Locust</a>, <a href=https://github.com/tsenart/vegeta target=_blank rel="noopener noreferrer">Vegeta</a>, <a href=https://gatling.io/ target=_blank rel="noopener noreferrer">Gatling</a> etc.</li><li>Visual Studio Diagnostics Tools Or</li><li>Use tools like Perfview/dotTrace/dotMemory to diagnose bottlenecks</li></ul><p>What if it is possible to Benchmark code for,</p><ul><li>Set of varying parameter(s)</li><li>Different runtimes (.NET Framework versions, .NET core, Mono etc.) with option to Benchmark it</li><li>Observe Memory Allocations for diagnostics</li><li>Get Detailed report on execution timeline</li><li>Have it as part of test suite so that it can be easily executed with every iteration involving optimized code to get immediate feedback</li></ul><p>Enter <a href=https://benchmarkdotnet.org/ target=_blank rel="noopener noreferrer">BenchmarkDotNet</a>, a Powerful .NET library for benchmarking. It is used by <a href=https://github.com/dotnet/performance target=_blank rel="noopener noreferrer">DotNET</a> Team, Roslyn, ASP.NET Core and many other projects.</p><p>Though <a href=https://benchmarkdotnet.org/ target=_blank rel="noopener noreferrer">Benchmarkdotnet.org</a> has nice documentation with detailed examples, Below we will look at how to benchmark a code which is aimed at dumping in-memory list of objects to a delimited file. In real-world scenario, the list of objects could be retrieved from external data store.</p><p>So Lets Start.</p><h2 id=approach>Approach</h2><p>We will have below before we proceed with using BenchmarkDotNet</p><ul><li>Dummy class that represents Data Structure to be dumped to a file,</li></ul><p><code><iframe src=//carbon.now.sh/embed/b2d914a563b49d4dd50a4143166f27ec style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe></code></p><p>Refer Gist <a href=https://gist.github.com/sachinsu/b2d914a563b49d4dd50a4143166f27ec target=_blank rel="noopener noreferrer">here</a></p><ul><li><p>Class <code>CardWriter.cs</code> that generates file using,</p><ul><li>Using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.streamwriter?view=netcore-3.1" target=_blank rel="noopener noreferrer">StreamWriter</a> with Buffer</li><li>Using Stringbuilder and StreamWriter</li><li>Using Open source <a href=https://joshclose.github.io/CsvHelper/ target=_blank rel="noopener noreferrer">CSVHelper</a> library</li></ul></li></ul><p><code><iframe src="//carbon.now.sh/embed/b2d914a563b49d4dd50a4143166f27ec?filename=CardWriter.cs" style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe></code></p><p>Refer Gist <a href=https://gist.github.com/sachinsu/b2d914a563b49d4dd50a4143166f27ec#file-cardwriter-cs target=_blank rel="noopener noreferrer">here</a></p><ul><li>Now, let us write code to benchmark above functions with Memory Diagnostics,</li></ul><p><code><iframe src="//carbon.now.sh/embed/b2d914a563b49d4dd50a4143166f27ec?filename=Program.cs" style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe></code></p><p>Refer Gist <a href=https://gist.github.com/sachinsu/b2d914a563b49d4dd50a4143166f27ec#file-program-cs target=_blank rel="noopener noreferrer">here</a></p><p>Above code,</p><ul><li>Class <code>FileGeneratorBenchmark</code> - This class uses BenchmarkDotNET attributes to decorate set of functions which in turn call functions from <code>CardWriter.cs</code> class.</li><li>Class <code>Program</code> - General purpose class with static <code>main</code> function that invokes <code>BenchmarkRunner</code> to execute benchmarks.</li></ul><p>It is required to run these benchmarks in <code>Release</code> mode or else BenchmarkDotNet will alert about the same. After running the benchmark, It will generate detailed report like below,</p><p><img alt="Benchmark Result" src=/images/capture.png></p><p>Report shows Memory Allocation as well as Execution time lines across Platform (.NET Framework Vesions) and parameters.</p><p>References:</p><ul><li><a href=https://benchmarkdotnet.org target=_blank rel="noopener noreferrer">BenchmarkDotNet</a></li><li><a href=https://www.stevejgordon.co.uk/introduction-to-benchmarking-csharp-code-with-benchmark-dot-net target=_blank rel="noopener noreferrer">Introduction to Benchmarking C# Code with Benchmark .NET</a></li></ul><p>Happy Coding !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/samesitecookies/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>ASP.NET Core - Mind the SameSite HTTP Cookie settings</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/posts/windowsservicecancellabletask/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Windows Service with Cancelable Task</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Sachin Sunkle.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>