<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Troubleshooting TLS handshake issue - Learnings in IT</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Troubleshooting TLS handshake issue"><meta property="og:description" content="Background Ever encountered a scenario where REST API consumption works from tools like curl, Web Browser but not from Application. Lets dive in.
The requirement is as simple as consuming REST API from a Application over TLS.
Problem Statement The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.
During Development, Windows 10 is used to develop and test the code."><meta property="og:type" content="article"><meta property="og:url" content="https://sachinsu.github.io/posts/tlshandsharefailure/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-25T10:25:04+05:30"><meta property="article:modified_time" content="2023-02-25T10:25:04+05:30"><meta itemprop=name content="Troubleshooting TLS handshake issue"><meta itemprop=description content="Background Ever encountered a scenario where REST API consumption works from tools like curl, Web Browser but not from Application. Lets dive in.
The requirement is as simple as consuming REST API from a Application over TLS.
Problem Statement The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.
During Development, Windows 10 is used to develop and test the code."><meta itemprop=datePublished content="2023-02-25T10:25:04+05:30"><meta itemprop=dateModified content="2023-02-25T10:25:04+05:30"><meta itemprop=wordCount content="484"><meta itemprop=keywords content="Wireshark,TCP,TLS,.NET,Schannel,SSPI,Bouncy Castle,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Troubleshooting TLS handshake issue"><meta name=twitter:description content="Background Ever encountered a scenario where REST API consumption works from tools like curl, Web Browser but not from Application. Lets dive in.
The requirement is as simple as consuming REST API from a Application over TLS.
Problem Statement The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.
During Development, Windows 10 is used to develop and test the code."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-169012216-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Learnings in IT" rel=home><div class="logo__item logo__text"><div class=logo__title>Learnings in IT</div><div class=logo__tagline>A Simple Technical Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li><li class=menu__item><a class=menu__link href=/posts/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/projects/><span class=menu__text>Projects</span></a></li><li class=menu__item><a class=menu__link href=https://gist.github.com/sachinsu><span class=menu__text>Gists</span></a></li><li class=menu__item><a class=menu__link href=/links/home><span class=menu__text>Useful Links</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Troubleshooting TLS handshake issue</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Sachin Sunkle</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-02-25T10:25:04+05:30>Feb 25 2023</time></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#problem-statement>Problem Statement</a></li><li><a href=#causal-analysis>Causal Analysis</a><ul><li><a href=#using-curl>Using CURL</a></li><li><a href=#via-application>Via Application</a></li></ul></li><li><a href=#wrap-up>Wrap up</a><ul><li><a href=#useful-references>Useful References,</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><h2 id=background>Background</h2><p>Ever encountered a scenario where REST API consumption works from tools like <a href=https://github.com/jeroen/curl target=_blank rel="noopener noreferrer">curl</a>, Web Browser but not from Application. Lets dive in.</p><p>The requirement is as simple as consuming REST API from a Application over TLS.</p><h2 id=problem-statement>Problem Statement</h2><p>The REST API, to be consumed, is standard API interface which requires access over TLS. The client in this case is Windows 2016 server.</p><p>During Development, Windows 10 is used to develop and test the code. Later, the same is tested on a Windows 2016 Server. It is at this stage, it fails with cryptic Error &ldquo;The request was aborted: Could not create SSL/TLS secure channel&rdquo;. But it works fine with other tools like curl, PostMan or even from a Web Browser.</p><figure><img src=/images/wireshark-dotnet-error.png><figcaption><h4>Network trace log from Application</h4></figcaption></figure><h2 id=causal-analysis>Causal Analysis</h2><p>Given that this error was related TLS/SSL and it is standard across platforms. What could be the reason for this behavior? With not much luck with Application level trace, its time to take help of <a href=https://www.wireshark.org/ target=_blank rel="noopener noreferrer">Wireshark</a>. If you are new to Wireshark then refer to <a href=https://jvns.ca/blog/2018/06/19/what-i-use-wireshark-for/ target=_blank rel="noopener noreferrer">this</a> excellent write-up by Julia Evans.</p><p>So, i used wireshark during test from CURL as well as from the Application and below is what is shows,</p><h3 id=using-curl>Using CURL</h3><figure><img src=/images/wireshark-curl-1.png><figcaption><h4>List of Ciphers Exchanged during 'Client Hello'</h4></figcaption></figure><figure><img src=/images/wireshark-curl-2.png><figcaption><h4>Cipher returned by Server during 'Server Hello'</h4></figcaption></figure><p>With CURl, TLS handshare happens as intended and API works as expected.</p><h3 id=via-application>Via Application</h3><ul><li><p>Below is list of ciphers exchanged and list is considerably short compared to earlier.</p><figure><img src=/images/wireshark-app-1.png><figcaption><h4>List of Ciphers Exchanged during 'Client Hello'</h4></figcaption></figure></li><li><p>Below is error logged</p><figure><img src=/images/wireshark-app-2.png><figcaption><h4>TLS handshake Error</h4></figcaption></figure></li></ul><p>To understand this behavior, Let&rsquo;s do a quick primer.</p><p>There are many implementations of TLS/SSL (a.k.a. Security service providers) available across platforms. Notably,</p><ul><li><p><a href=https://en.wikipedia.org/wiki/Network_Security_Services target=_blank rel="noopener noreferrer">Network Security Services</a> This is used by browsers like Firefox</p></li><li><p><a href=https://en.wikipedia.org/wiki/LibreSSL target=_blank rel="noopener noreferrer">LibreSSL</a> - Used by Chrome, curl (in ready-to-use build, refer <a href=https://everything.curl.dev/build/tls target=_blank rel="noopener noreferrer">here</a>)</p></li></ul><p>Refer <a href=https://en.wikipedia.org/wiki/Comparison_of_TLS_implementations target=_blank rel="noopener noreferrer">here</a> for nice comparison of various implementations in summary format.</p><p>`Microsoft Windows has its own Implementation called Windows SSPI (a.k.a. schannel SSPI). As per <a href=https://learn.microsoft.com/en-us/windows-server/security/tls/tls-ssl-schannel-ssp-overview target=_blank rel="noopener noreferrer">TLS/SSL Overview</a>,</p><pre tabindex=0><code>
Schannel is a Security Support Provider (SSP) that implements the Secure Sockets Layer (SSL) and Transport Layer Security (TLS) Internet standard authentication protocols.
</code></pre><p>Microsoft Windows and development platforms like .NET use this implementation by default. Via this provider it is possible for Administrators to enforce policies like restrict version of TLS, usage of ciphers and so on. Note that, as part of Security/Compliance requirements, It is often necessary to have these policies enforced and this is exactly what was done.</p><p>Below is Sample C# code using <a href=https://github.com/bcgit/bc-csharp target=_blank rel="noopener noreferrer">BouncyCastle</a> (alternate library for cryptography)</p><iframe src=//carbon.now.sh/embed/22bb5e70334101dba1880de3a6c0e504 style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe><h2 id=wrap-up>Wrap up</h2><p>Hence, the resolution for this could be,</p><ul><li>Make sure that Server hosting the API complies with any of the ciphers allowed on the client.</li><li>In case if this is not possible then , Cipher restrictions on the client will have to be modified (assuming its within the requirement for Compliance).</li></ul><h3 id=useful-references>Useful References,</h3><p>1 - <a href=https://github.com/jeroen/curl/issues/100 target=_blank rel="noopener noreferrer">CURL using OpenSSL in default build</a></p><p>Happy Troubleshooting !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/wireshark/ rel=tag>Wireshark</a></li><li class=tags__item><a class="tags__link btn" href=/tags/tcp/ rel=tag>TCP</a></li><li class=tags__item><a class="tags__link btn" href=/tags/tls/ rel=tag>TLS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/.net/ rel=tag>.NET</a></li><li class=tags__item><a class="tags__link btn" href=/tags/schannel/ rel=tag>Schannel</a></li><li class=tags__item><a class="tags__link btn" href=/tags/sspi/ rel=tag>SSPI</a></li><li class=tags__item><a class="tags__link btn" href=/tags/bouncy-castle/ rel=tag>Bouncy Castle</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Sachin Sunkle</span></div><div class=authorbox__description>A Coder in IT</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/shortidgeneration/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>URL Shortener in High Throughput Service</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Sachin Sunkle.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>