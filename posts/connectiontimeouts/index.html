<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Trobleshooting TCP Connection request time outs - Learnings in IT</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Trobleshooting TCP Connection request time outs"><meta property="og:description" content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
High Level Architecture Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta property="og:type" content="article"><meta property="og:url" content="https://sachinsu.github.io/posts/connectiontimeouts/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-25T10:25:04+05:30"><meta property="article:modified_time" content="2020-08-25T10:25:04+05:30"><meta itemprop=name content="Trobleshooting TCP Connection request time outs"><meta itemprop=description content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
High Level Architecture Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta itemprop=datePublished content="2020-08-25T10:25:04+05:30"><meta itemprop=dateModified content="2020-08-25T10:25:04+05:30"><meta itemprop=wordCount content="829"><meta itemprop=keywords content="Oracle,TCP,Firewall,.NET,Polly,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trobleshooting TCP Connection request time outs"><meta name=twitter:description content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
High Level Architecture Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-169012216-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Learnings in IT" rel=home><div class="logo__item logo__text"><div class=logo__title>Learnings in IT</div><div class=logo__tagline>A Simple Technical Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li><li class=menu__item><a class=menu__link href=/posts/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=/projects/><span class=menu__text>Projects</span></a></li><li class=menu__item><a class=menu__link href=https://gist.github.com/sachinsu><span class=menu__text>Gists</span></a></li><li class=menu__item><a class=menu__link href=/links/home><span class=menu__text>Useful Links</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Trobleshooting TCP Connection request time outs</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Sachin Sunkle</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-08-25T10:25:04+05:30>Aug 25 2020</time></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#problem-statement>Problem Statement</a></li><li><a href=#approach>Approach</a></li><li><a href=#wrap-up>Wrap up</a></li></ul></nav></div></div><div class="content post__content clearfix"><h2 id=background>Background</h2><p>I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.</p><p>Simplified deployment Architecture is as below,</p><figure><img src=/images/conntimeoutarch.png><figcaption><h4>High Level Architecture</h4></figcaption></figure><p>Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic. These applications connect to Oracle Database.</p><p>Team is experienced in developing and running .NET Apps, but they needed help to diagnose and fix &ldquo;Connection request timed out&rdquo; exceptions being thrown while connecting to backend database.</p><h2 id=problem-statement>Problem Statement</h2><p>Host of .NET Applications (Web Applications, Web APIs) connect to Oracle Database. Each of them use <a href=https://www.oracle.com/database/technologies/appdev/dotnet/odp.html target=_blank rel="noopener noreferrer">ODP.NET</a>. ODP.NET maintains connection pool per Application domain (Database resident Connection pool is not used). Some of these applications receive high number of requests per second compared to others.</p><p><code>Oracle.ManagedDataAccess.Client.OracleException (0x80004005): Connection request timed out....</code> has been reported randomly which results in failure of business transactions. ODP.NET provides extensive trace and along with above trace also contains <code>OracleInternal.Network.NetworkException (0x80004005): Network Transport: TCP transport address connect failure ---> System.Net.Sockets.SocketException (0x80004005): A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond</code></p><p>Specifically, Applications, receiving less traffic, were reporting it often compared to those with high traffic.</p><h2 id=approach>Approach</h2><ul><li>Simulate the Exception in Test Environment - We decided to try and simulate this exception in a Test Environment. Test environment is scaled down (50%) compared to production. Random Exceptions in production could not be simulated due to lack of Test Automation. for example, In Production, each server receives traffic for multiple HTTP End points whereas in Test environment, load testing was being done only against Single Application.</li></ul><p>This was like a end of the road since simulation would have greatly helped in diagnosing the issue. However, the show must go on so we decided to,</p><ul><li><p>Check online documentation regarding this exception,</p><ul><li><p>&ldquo;Pooled&rdquo; or &ldquo;Non-pooled&rdquo; Connection - Whenever, ODP.NET raises &ldquo;..timed out&rdquo; error, it diffrentiates the same to indicate whether error is due to delay in retrieving connection from pool or if it is due to delay from the database server (Ref: <a href=https://docs.oracle.com/en/database/oracle/oracle-data-access-components/19.3/odpnt/featConnecting.html#GUID-1152D13D-464C-4FE7-9949-32FCA9572B59 target=_blank rel="noopener noreferrer">Here</a>). From this, it was clear that issue is clearly due to delay in obtaining response from database server.While this was happening , Database server (8 CPU Core box) was reporting less than 50% CPU Usage but it still had large number of inactive sessions originated from IIS Servers.</p></li><li><p>Since the exception was reported frequently in low traffic applications, it was decided to track and verify the same on firewall and database server,</p><ul><li><p>Firewall - Firewall had TCP Timeout of 30 minutes and maintains detailed log of sessions. Quick analysis of it revealed that,</p><ul><li>Production Environment - Unusually high number of sessions were being destroyed due to &ldquo;Age out&rdquo; (i.e. time out)</li><li>Test Environment - No abnormal activity was reported. Most probably because of differences in traffic.</li></ul></li><li><p>Database Server - Listener Log on Oracle Database server did not had any log entry for request at the precise time when Application(s) had reported Exception.</p></li></ul></li><li><p>Next is to check settings in Application for connectivity with Oracle. Though ODP.NET does not have any direct &ldquo;Time out&rdquo; or &ldquo;Time to live&rdquo; settings, it does provide few parameters that can influence it,</p><ul><li>&ldquo;Connection Lifetime&rdquo; - ODP.NET uses this whenever Connection is closed and disposed by the Application. It will be destroyed (after maintaining number of connections as per &ldquo;Min Pool Size&rdquo;) if it has exceeded life time. For whatever reasons, this was set to unusually high duration (i.e. 90000 seconds).</li><li>&ldquo;Connection Timeout&rdquo; - Period for which ODP.NET waits for the connection to be made available. This was set to 60 Seconds.</li></ul></li><li><p>Oracle has articles titled &ldquo;ODP-1000 &ldquo;Connection Request Timed Out&rdquo; Explained&rdquo; and &ldquo;Resolving Problems with Connection Idle Timeout With Firewall (Doc ID 257650.1)&rdquo; where it primarily recommends measures for tuning Application as well as database.</p></li></ul><p>On the basis of above, it was decided to modify the code for below,</p><ul><li>Thorough code review to verify that every ODP.NET Project is closed/disposed.</li><li>Upgrade ODP.NET to latest version (v19.8.0 as of this writing)</li><li>Turn &ldquo;KeepAlive&rdquo; while connecting to database</li><li>Leverage ODP.NET tracing in case of exception</li><li>Modify the connection lifetime to be less than time out at firewall and increase the &ldquo;Time out&rdquo; period.</li><li>Introduce Retry functionality using Excellent <a href=https://github.com/App-vNext/Polly target=_blank rel="noopener noreferrer">Polly</a> library with exponential back-off.</li></ul><p><code><iframe src="//carbon.now.sh/embed/d3888ab4418b937a650e880ec4682653?filename=extensions.cs" style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe></code></p><p>These changes have been deployed to production and so far % of &ldquo;Connection Request Timed out&rdquo; errors have gone down significantly.</p></li></ul><h2 id=wrap-up>Wrap up</h2><p>Some key areas of focus are,</p><ul><li>For a distributed system, Always validate assumptions by dignosing end to end.</li><li>Plan to have test automation readyness to simulate production like load.</li><li>Monitoring the behavior end to end using logs.</li><li>Currently, Pool settings across applications is not optimal going by Oracle Real world Guidelines, also be mindful of <a href=https://docs.oracle.com/en/database/oracle/oracle-database/18/adfns/connection_strategies.html target=_blank rel="noopener noreferrer">Connection Storms</a></li></ul><p>Happy Troubleshooting !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/oracle/ rel=tag>Oracle</a></li><li class=tags__item><a class="tags__link btn" href=/tags/tcp/ rel=tag>TCP</a></li><li class=tags__item><a class="tags__link btn" href=/tags/firewall/ rel=tag>Firewall</a></li><li class=tags__item><a class="tags__link btn" href=/tags/.net/ rel=tag>.NET</a></li><li class=tags__item><a class="tags__link btn" href=/tags/polly/ rel=tag>Polly</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><div class=authorbox__header><span class=authorbox__name>About Sachin Sunkle</span></div><div class=authorbox__description>A Coder in IT</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/massdmgolang/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Tool to mass DM followers on Twitter in Go</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/posts/urlhealthchecks/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Validating urls from 'Useful Links' section using bash / command line tools</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Sachin Sunkle.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>